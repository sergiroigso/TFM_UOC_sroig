---
title: "QC scRNAseq analysis"
author: "Sergi Roig"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    theme: cosmo
    highlight: textmate
    number_sections: true
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: '3'
  word_document:
    toc: true
    toc_depth: '3'
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
## Global options
library(knitr)
library(rmdformats)
library(tinytex)
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 60))
```

# Packages

```{r}
library(Seurat)
library(ggplot2)
library(SingleR)
library(dplyr)
library(celldex)
library(RColorBrewer)
library(SingleCellExperiment)
library(patchwork)
library(reshape2)
library(hdf5r)
```

# Data import

```{r}
# read the filtered Cell Ranger h5 matrices
spl_WT <- Read10X_h5("DATA/WT_SPsample_filtered_feature_bc_matrix.h5")
spl_KO <- Read10X_h5("DATA/KO_SP_sample_filtered_feature_bc_matrix.h5")
bm_WT  <- Read10X_h5("DATA/WT_BM_sample_filtered_feature_bc_matrix.h5")
bm_KO  <- Read10X_h5("DATA/KO_BM_sample_filtered_feature_bc_matrix.h5")

# create the appropriate Seurat
spl_WT_obj <- CreateSeuratObject(spl_WT, project = "spl_WT")
spl_KO_obj <- CreateSeuratObject(spl_KO, project = "spl_KO")
bm_WT_obj  <- CreateSeuratObject(bm_WT, project = "bm_WT")
bm_KO_obj  <- CreateSeuratObject(bm_KO, project = "bm_KO")

# let’s remove matrices to save memory
rm(spl_WT)
rm(spl_KO)
rm(bm_WT)
rm(bm_KO)
```

# Spleen WT

```{r}
# mitochondrial genes and ribosomal proteins
spl_WT_obj[["percent.mt"]]  <- PercentageFeatureSet(spl_WT_obj, pattern = "^mt-")
spl_WT_obj[["percent.rb"]] <- PercentageFeatureSet(spl_WT_obj, pattern = "^Rps|^Rpl")
# doublets from Scrublet (python)
doub_spl_WT <- read.csv("data/SCRUBLET/scrublet_WT_spl.csv",header = T,row.names = 1)
colnames(doub_spl_WT) <- c("Doublet_score","Is_doublet")
spl_WT_obj <- AddMetaData(spl_WT_obj,doub_spl_WT)
```

Let’s make violin plots of the selected metadata features. 

```{r}
VlnPlot(spl_WT_obj, features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"),ncol = 4,pt.size = 0.1) &
  theme(plot.title = element_text(size=10))
```

Let’s plot some of the metadata features against each other and see how they correlate. The number above each plot is a Pearson correlation coefficient.

```{r}
FeatureScatter(spl_WT_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(spl_WT_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(spl_WT_obj, feature1 = "nCount_RNA", feature2 = "percent.rb")
FeatureScatter(spl_WT_obj, feature1 = "percent.rb", feature2 = "percent.mt")
FeatureScatter(spl_WT_obj, feature1 = "nFeature_RNA", feature2 = "Doublet_score")
```

The plots above clearly show that high MT percentage strongly correlates with low UMI counts, and usually is interpreted as dead cells. High ribosomal protein content, however, strongly anti-correlates with MT, and seems to contain biological signal. There’s also a strong correlation between the doublet score and number of expressed genes. Let’s set QC column in metadata and define it in an informative way.

```{r}
spl_WT_obj[['QC']] <- ifelse(spl_WT_obj@meta.data$Is_doublet == 'True','Doublet','Pass')
spl_WT_obj[['QC']] <- ifelse(spl_WT_obj@meta.data$nFeature_RNA < 500 & spl_WT_obj@meta.data$QC == 'Pass','Low_nFeature',spl_WT_obj@meta.data$QC)
spl_WT_obj[['QC']] <- ifelse(spl_WT_obj@meta.data$nFeature_RNA < 500 & spl_WT_obj@meta.data$QC != 'Pass' & spl_WT_obj@meta.data$QC != 'Low_nFeature',paste('Low_nFeature',spl_WT_obj@meta.data$QC,sep = ','),spl_WT_obj@meta.data$QC)
spl_WT_obj[['QC']] <- ifelse(spl_WT_obj@meta.data$percent.mt > 15 & spl_WT_obj@meta.data$QC == 'Pass','High_MT',spl_WT_obj@meta.data$QC)
spl_WT_obj[['QC']] <- ifelse(spl_WT_obj@meta.data$nFeature_RNA < 500 & spl_WT_obj@meta.data$QC != 'Pass' & spl_WT_obj@meta.data$QC != 'High_MT',paste('High_MT',spl_WT_obj@meta.data$QC,sep = ','),spl_WT_obj@meta.data$QC)
table(spl_WT_obj[['QC']])
```

We can see that doublets don’t often overlap with cell with low number of detected genes; at the same time, the latter often co-insides with high mitochondrial content. Let’s plot metadata only for cells that pass tentative QC:

```{r}
VlnPlot(subset(spl_WT_obj, subset = QC == 'Pass'),
        features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4, pt.size = 0.1) & 
  theme(plot.title = element_text(size=10))
# Por QC
FeatureScatter(spl_WT_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "QC")
```

# Spleen PrimPol KO

```{r}
spl_KO_obj[["percent.mt"]]  <- PercentageFeatureSet(spl_KO_obj, pattern = "^mt-")
spl_KO_obj[["percent.rb"]] <- PercentageFeatureSet(spl_KO_obj, pattern = "^Rps|^Rpl")
# doublets
doub_spl_KO <- read.csv("data/SCRUBLET/scrublet_KO_spl.csv",header = T,row.names = 1)
colnames(doub_spl_KO) <- c("Doublet_score","Is_doublet")
spl_KO_obj <- AddMetaData(spl_KO_obj,doub_spl_KO)

# graphs
VlnPlot(spl_KO_obj, features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"),ncol = 4,pt.size = 0.1) &
  theme(plot.title = element_text(size=10))
FeatureScatter(spl_KO_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(spl_KO_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(spl_KO_obj, feature1 = "nCount_RNA", feature2 = "percent.rb")
FeatureScatter(spl_KO_obj, feature1 = "percent.rb", feature2 = "percent.mt")
FeatureScatter(spl_KO_obj, feature1 = "nFeature_RNA", feature2 = "Doublet_score")

# filtering
spl_KO_obj[['QC']] <- ifelse(spl_KO_obj@meta.data$Is_doublet == 'True','Doublet','Pass')
spl_KO_obj[['QC']] <- ifelse(spl_KO_obj@meta.data$nFeature_RNA < 500 & spl_KO_obj@meta.data$QC == 'Pass','Low_nFeature',spl_KO_obj@meta.data$QC)
spl_KO_obj[['QC']] <- ifelse(spl_KO_obj@meta.data$nFeature_RNA < 500 & spl_KO_obj@meta.data$QC != 'Pass' & spl_KO_obj@meta.data$QC != 'Low_nFeature',paste('Low_nFeature',spl_KO_obj@meta.data$QC,sep = ','),spl_KO_obj@meta.data$QC)
spl_KO_obj[['QC']] <- ifelse(spl_KO_obj@meta.data$percent.mt > 15 & spl_KO_obj@meta.data$QC == 'Pass','High_MT',spl_KO_obj@meta.data$QC)
spl_KO_obj[['QC']] <- ifelse(spl_KO_obj@meta.data$nFeature_RNA < 500 & spl_KO_obj@meta.data$QC != 'Pass' & spl_KO_obj@meta.data$QC != 'High_MT',paste('High_MT',spl_KO_obj@meta.data$QC,sep = ','),spl_KO_obj@meta.data$QC)
table(spl_KO_obj[['QC']])
VlnPlot(subset(spl_KO_obj, subset = QC == 'Pass'),
        features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4, pt.size = 0.1) & 
  theme(plot.title = element_text(size=10))
# Por QC
FeatureScatter(spl_KO_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "QC")
```

# Bone Marrow WT

```{r}
bm_WT_obj[["percent.mt"]]  <- PercentageFeatureSet(bm_WT_obj, pattern = "^mt-")
bm_WT_obj[["percent.rb"]] <- PercentageFeatureSet(bm_WT_obj, pattern = "^Rps|^Rpl")
# doublets
doub_bm_WT <- read.csv("data/SCRUBLET/scrublet_WT_BM.csv",header = T,row.names = 1)
colnames(doub_bm_WT) <- c("Doublet_score","Is_doublet")
bm_WT_obj <- AddMetaData(bm_WT_obj,doub_bm_WT)

# graphs
VlnPlot(bm_WT_obj, features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"),ncol = 4,pt.size = 0.1) &
  theme(plot.title = element_text(size=10))
FeatureScatter(bm_WT_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(bm_WT_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(bm_WT_obj, feature1 = "nCount_RNA", feature2 = "percent.rb")
FeatureScatter(bm_WT_obj, feature1 = "percent.rb", feature2 = "percent.mt")
FeatureScatter(bm_WT_obj, feature1 = "nFeature_RNA", feature2 = "Doublet_score")

# filtering
bm_WT_obj[['QC']] <- ifelse(bm_WT_obj@meta.data$Is_doublet == 'True','Doublet','Pass')
bm_WT_obj[['QC']] <- ifelse(bm_WT_obj@meta.data$nFeature_RNA < 500 & bm_WT_obj@meta.data$QC == 'Pass','Low_nFeature',bm_WT_obj@meta.data$QC)
bm_WT_obj[['QC']] <- ifelse(bm_WT_obj@meta.data$nFeature_RNA < 500 & bm_WT_obj@meta.data$QC != 'Pass' & bm_WT_obj@meta.data$QC != 'Low_nFeature',paste('Low_nFeature',bm_WT_obj@meta.data$QC,sep = ','),bm_WT_obj@meta.data$QC)
bm_WT_obj[['QC']] <- ifelse(bm_WT_obj@meta.data$percent.mt > 15 & bm_WT_obj@meta.data$QC == 'Pass','High_MT',bm_WT_obj@meta.data$QC)
bm_WT_obj[['QC']] <- ifelse(bm_WT_obj@meta.data$nFeature_RNA < 500 & bm_WT_obj@meta.data$QC != 'Pass' & bm_WT_obj@meta.data$QC != 'High_MT',paste('High_MT',bm_WT_obj@meta.data$QC,sep = ','),bm_WT_obj@meta.data$QC)
table(bm_WT_obj[['QC']])
VlnPlot(subset(bm_WT_obj, subset = QC == 'Pass'),
        features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4, pt.size = 0.1) & 
  theme(plot.title = element_text(size=10))
# Por QC
FeatureScatter(bm_WT_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "QC")
```

# Bone Marrow PrimPol KO

```{r}
# PrimPol KO bone marrow
bm_KO_obj[["percent.mt"]]  <- PercentageFeatureSet(bm_KO_obj, pattern = "^mt-")
bm_KO_obj[["percent.rb"]] <- PercentageFeatureSet(bm_KO_obj, pattern = "^Rps|^Rpl")
# doublets
doub_bm_KO <- read.csv("data/SCRUBLET/scrublet_KO_BM.csv",header = T,row.names = 1)
colnames(doub_bm_KO) <- c("Doublet_score","Is_doublet")
bm_KO_obj <- AddMetaData(bm_KO_obj,doub_bm_KO)

# graphs
VlnPlot(bm_KO_obj, features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"),ncol = 4,pt.size = 0.1) &
  theme(plot.title = element_text(size=10))
FeatureScatter(bm_KO_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(bm_KO_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(bm_KO_obj, feature1 = "nCount_RNA", feature2 = "percent.rb")
FeatureScatter(bm_KO_obj, feature1 = "percent.rb", feature2 = "percent.mt")
FeatureScatter(bm_KO_obj, feature1 = "nFeature_RNA", feature2 = "Doublet_score")

# filtering
bm_KO_obj[['QC']] <- ifelse(bm_KO_obj@meta.data$Is_doublet == 'True','Doublet','Pass')
bm_KO_obj[['QC']] <- ifelse(bm_KO_obj@meta.data$nFeature_RNA < 500 & bm_KO_obj@meta.data$QC == 'Pass','Low_nFeature',bm_KO_obj@meta.data$QC)
bm_KO_obj[['QC']] <- ifelse(bm_KO_obj@meta.data$nFeature_RNA < 500 & bm_KO_obj@meta.data$QC != 'Pass' & bm_KO_obj@meta.data$QC != 'Low_nFeature',paste('Low_nFeature',bm_KO_obj@meta.data$QC,sep = ','),bm_KO_obj@meta.data$QC)
bm_KO_obj[['QC']] <- ifelse(bm_KO_obj@meta.data$percent.mt > 15 & bm_KO_obj@meta.data$QC == 'Pass','High_MT',bm_KO_obj@meta.data$QC)
bm_KO_obj[['QC']] <- ifelse(bm_KO_obj@meta.data$nFeature_RNA < 500 & bm_KO_obj@meta.data$QC != 'Pass' & bm_KO_obj@meta.data$QC != 'High_MT',paste('High_MT',bm_KO_obj@meta.data$QC,sep = ','),bm_KO_obj@meta.data$QC)
table(bm_KO_obj[['QC']])
VlnPlot(subset(bm_KO_obj, subset = QC == 'Pass'),
        features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4, pt.size = 0.1) & 
  theme(plot.title = element_text(size=10))
# Por QC
FeatureScatter(bm_KO_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "QC")
```

